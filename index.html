<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
		<title>Trade Center</title>
		<style type="text/css" title="currentStyle">
			@import "css/demo_page.css";
			@import "css/demo_table.css";
		</style>
		<link rel="stylesheet" href="css/themes/base/jquery.ui.all.css">
		<link rel="stylesheet" href="css/demos.css">
		<script type='text/javascript' src="js/jquery-2.1.0.min.js"></script>
		<script type='text/javascript' src="js/jquery.dataTables.min.js"></script>
		<script type='text/javascript' src="js/ui/jquery.ui.core.js"></script>
		<script type='text/javascript' src="js/ui/jquery.ui.widget.js"></script>
		<script type='text/javascript' src="js/ui/jquery.ui.button.js"></script>
		<script type='text/javascript' src="js/ui/jquery.ui.widget.js"></script>
		<script type='text/javascript' src="js/ui/jquery.ui.position.js"></script>
		<script type='text/javascript' src="js/ui/jquery.ui.tooltip.js"></script>
		<script type='text/javascript' src="js/ui/jquery.ui.menu.js"></script>
		<style>
			#toolbar {
				padding: 4px;
				display: inline-block;
			}
			/* support: IE7 */
			*+ html #toolbar {
				display: inline;
			}
			.ui-menu { position: absolute; width: 55px; z-index:999 }
			.tag {
				border : 1px solid #a5d24a;
				padding : 5px;
				font-family: monospace;
				/*background : #cde69c;*/
			}
			.tag.tgwtb{
				background : #cde69c;
			}
			.tag.tgwts{
				background : #9CCBE6;
			}
			.tag.tgwtt{
				background : #FFF8AB;
			}
			.alignMiddle { text-align: middle; }
		</style>
		<script type="text/javascript" charset="utf-8">
            $(document).ready(function() {
                /// jQuery UI
                $("#home").button({
                    icons : {
                        primary : "ui-icon-home"
                    }
                }).click(function() {
                    top.location.href = "/index.html";
                });
                $("#add").button({
                    icons : {
                        primary : "ui-icon-circle-plus"
                    }
                }).click(function() {
                    top.location.href = "/insert.html";
                });
                $("#Rev").button();
				$("#type" ).buttonset();
                // **** datatable ****
                //$('#tbl').dataTable();
                $('#tbl').dataTable({
                    "bJQueryUI" : true,
                    "bProcessing" : true,
                    "bServerSide" : true,
					"sScrollY": 350,
                    // 数据源
                    "sAjaxSource" : "q1.php",
                    // 传递参数进入php
                    "fnServerParams" : function(aoData) {
						// 选择的交易类型 
                        aoData.push({
                            "name" : "wtb",
                            "value" : "1"
                        },{
                            "name" : "wts",
                            "value" : "1"
						},{
                            "name" : "wtt",
                            "value" : "1"
						});
                    },
                    "fnDrawCallback" : function(oSettings) {
						//$(".tag").
						$("#menu").menu();
                        $(".del").button({
                            text : false,
                            icons : {
                                primary : "ui-icon-trash"
                            }
                        }).click(function() {
							 delete_order(this);
                        });
                        $( ".btnManage" )
							.button({
									text: false,
									icons: {
										primary: "ui-icon-trash"
									}
							})
							.click(function() {
								alert( "TODO:Delete This Record" );
							})
							.next()
								.button({
									text: false,
									icons: {
										primary: "ui-icon-triangle-1-s"
									}
								})
								.click(function() {
									var menu = $( this ).parent().next().show();
									//$(document).one( "click", function() {
									//		menu.hide();
									//});
									return false;
								})
								.mouseleave(function(){
								  	$(this).parent().next().hide();
									return false;
								})
								.parent()
									.buttonset()
									.next()
										.hide()
										.menu();
                    },
                    // 格式化输出
                    "aoColumnDefs" : [{
                        "mData" : "idwtb",
                        "aTargets" : [0],
						"asSorting": [ "asc" ],
                        "mRender" : function(data, type, full) {
                            // 'full' is the row's data object, and 'data' is this column's data
                            // e.g. 'full[0]' is the comic id, and 'data' is the comic title
                            return "<button class=\"del\">" + "	del this bid" + "</button>" + data;
                        }
                    }, {
                        "mData" : "type",
                        "aTargets" : [1],
						//"bSortable": false,
                        "mRender" : function(data, type, full) {
                            // 'full' is the row's data object, and 'data' is this column's data
                            // e.g. 'full[0]' is the comic id, and 'data' is the comic title
							if(data=="0"){
								return '<span class="tag tgwtb">wtb</span>';
							}else if(data=="1"){
								return '<span class="tag tgwts">wts</span>';
							}else if(data=="2"){
								return '<span class="tag tgwtt">wtt</span>';
							}else{
								return "E:"+data;
							}
                        }
                    },{
                        "mData" : "item_name",
                        "aTargets" : [2]
                    }, {
                        "mData" : "play_name",
                        "aTargets" : [3],
						"mRender" : function(data, type, full) {
                            return '<a href="http://forums.e-hentai.org/index.php?showuser=' + full.idplay + '">'+data+'</a>';
                        }
                    }, {
                        "mData" : "c",
                        "aTargets" : [4],
                        "mRender" : function(data, type, full) {
							if(data=="0" || data=="" || data==null ){
								return "-"
							}
                            return parseInt(data).toLocaleString();
                        }
                    }, {
                        "mData" : "hath",
                        "aTargets" : [5],
                        "mRender" : function(data, type, full) {
							if(data=="0" || data=="" || data==null ){
								return "-"
							}
                            return parseInt(data).toLocaleString();
                        }
                    }, {
                        "mData" : "num_want",
						"bSortable": false,
                        "aTargets" : [6],
                        "mRender" : function(data, type, full) {
							if(data=="0" || data=="" || data==null ){
								return "Unlimited"
							}
							return data
                        }
                    }, {
						///	 bbs连接
                        "mData" : "src",
						"bSortable": false,
                        "aTargets" : [7],
                        "mRender" : function(data, type, full) {
                            // 'full' is the row's data object, and 'data' is this column's data
                            // e.g. 'full[0]' is the comic id, and 'data' is the comic title
                            return '<a href="' + data + '">link</a>';
                        }
                    }, {
						/// 更新时间
                        "mData" : "timestamp",
						"bSortable": false,
                        "aTargets" : [8],
                        "mRender" : function(data, type, full) {
							// unix时间戳转化成为毫秒
							d=new Date(data*1000);
                            return d.toLocaleString() ;
                        }
                    }, {
						/// 备注
                        "mData" : "note",
						"bSortable": false,
                        "aTargets" : [9],
                        "mRender" : function(data, type, full) {
                            return data ;
                        }
                    }, {
						/// 管理按钮
						"mData" : "note",
						"bSortable": false,
                        "aTargets" : [10],
                        "mRender" : function(data, type, full) {
                            return '<span>'
								+'	<button class="btnManage">Delete</button>'
								+'	<button class="select">Set</button>'
								+'</span>'
								+'<ul id="menu">'
								+'	<li><a href="#"><span class="ui-icon ui-icon-pencil"></span>Edit</a></li>'
								+'</ul>';
                        }
                    }]
                });

            });
            function delete_order(btndel) {
                $.ajax({
                    type : "post",
                    url : "delete.php",
                    contentType : "application/x-www-form-urlencoded; charset=utf-8",
                    dataType : "text",
                    data : "wtbid="+btndel.parentElement.lastChild.textContent,
                    beforeSend : function(XMLHttpRequest) {
                       // $("#wait")[0].textContent = "waitng";
						btndel.parentElement.lastChild.textContent="..."
                    },
                    //成功(先成功,后完成)
                    success : function(data, textStatus) {
						// alert("reset: "+data);
						if(data!="1"){
							alert("reset err: "+data);
						}
						$(btndel.parentElement.parentElement).hide("slow");
                    },
                    error : function(XMLHttpRequest, textStatus, errorThrown) {
                        alert("ERR:" + XMLHttpRequest.responseText);
                    }
                });
            }
		</script>
	</head>
	<body>
		<div>
			<div align="">
				<div id="toolbar" class="ui-widget-header ui-corner-all">
					<button id="home" value="Submit">Home</button>
					<button id="add" title="新增交易条目">Add</button>
					<input type="checkbox" id="Rev" title="保留"><label for="Rev">Rev</label>
					<span id="type">
						<input type="checkbox" id="enb_wtb" title="显示求购信息"><label for="enb_wtb">WTB</label>
						<input type="checkbox" id="enb_wts" title="显示出售信息"><label for="enb_wts">WTS</label>
						<input type="checkbox" id="enb_wtt" title="未实现"><label for="enb_wtt">Rev.</label>
					</span>
				</div>
			</div>
			<p></p>
			<div>
				<table id="tbl" cellpadding="0" cellspacing="0" border="1" class="display" width="100%">
					<thead>
						<tr>
							<th width="8%"  title="交易编号">ID</th>
							<th width="6%"  title="类型">Type</th>
							<th width="15%" title="物品名称">Item name</th>
							<th width="13%" title="玩家名称">Player name</th>
							<th width="8%" title="-表示不接受Credit">Credit</th>
							<th width="7%" title="-表示不接受Hath">Hath</th>
							<th width="6%" title="物品数量">Qty.</th>
							<th width="5%" title="bbs 连接">Ref.</th>
							<th width="14%" title="交易加入时间">Time</th>
							<th title="备注">note</th>
							<th width="70px" title="管理动作">Manage</th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td colspan="10" class="dataTables_empty" align="middle">Loading data from server 正在从服务器加载数据 ...</td>
						</tr>
					</tbody>
				</table>
				<p></p>
				<div align="right">
					<label>Trade Center v0.1.4 </br></label>
					<label>source code:<a href='https://github.com/zodiac1111/wtb-db'>https://github.com/zodiac1111/wtb-db</a></label>
				</div>
			</div>
		</div>
	</body>
</html>
